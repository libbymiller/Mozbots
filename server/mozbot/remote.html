<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <link rel="stylesheet" href="remote.css" />
</head>

<body onload="openOrJoinRoom()">
  <div id="header">
    <div class="third" id="name">Mozbot - remote side</div>
    <div class="third" style="text-align: center;" id="status">DISCONNECTED</div>
    <div class="third" style="text-align: right;" id="num_connected">0 participants</div>
  </div>


<div class="centre">
   <span id="mute">ðŸ”‡</span>
</div>

<div>
 <span id="room-urls"></span>
</div>

<h2>Local, should be MUTED</h2>
<p>show just audio</p>

  <audio id="local" controls autoplay muted></audio>

<h2>Remote, should not be muted</h2>
<p>show both audio and video</p>
  <video id="remote" controls autoplay></video>


  <div id="chat-container">
    <div class="chat-output"></div>
  </div>

</body>        
<script src="/socket.io/socket.io.js"></script>
<script>
const url = "ws://localhost:80";
let move_socket = new WebSocket(url);
const i_am_remote = true; //flag for muting that happens in simple-webrtc.js

</script>

<script src="/dist/RTCMultiConnection.js"></script>
<script src="/mozbot/simple-webrtc.js"></script>        

<script>

//the bot sends audio and video, the remote client just audio
connection.mediaConstraints.video = false;

//for commands we use the data channel
connection.session = {
    video: false,
    audio: true,
    data: true
};

//for commands we use the data channel
connection.onmessage = appendDIV;

//for debugging
connection.onopen = function() {
  var num_participants = connection.getAllParticipants().length;
  document.querySelector('#num_connected').innerHTML = num_participants;
};

// a websocket server running on the pi
// for sending lights and movement messages

move_socket.onopen = function(e) {
  console.log("[open] Connection established");
  console.log("Sending to server");
  move_socket.send("arrived");
};

move_socket.onmessage = function(event) {
  console.log(`[message] Data received from server: ${event.data}`);
};

move_socket.onclose = function(event) {
  if (event.wasClean) {
    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
  } else {
    // e.g. server process killed or network down
    // event.code is usually 1006 in this case
    console.log('[close] Connection died - reconnecting');
  }
  move_socket = new WebSocket(url);
};

move_socket.onerror = function(error) {
  console.log(`[error] ${error.message}`);
};

// show the commands and send them

var chatContainer = document.querySelector('.chat-output');

function appendDIV(event) {
  console.log("data",event.data);
  move_socket.send(event.data);
  var div = document.createElement('div');
  div.innerHTML = event.data || event;
  chatContainer.insertBefore(div, chatContainer.firstChild);
  div.tabIndex = 0;
  div.focus();
}

//mute / unmute
document.querySelector('#mute').onclick = function() {
  if (this.innerHTML == 'ðŸ”‡') {
      this.innerHTML = 'ðŸ”‰';
      console.log("unmuting!");

      console.log("window.local_stream",window.local_stream);
      window.local_stream.unmute();

   }else {
      this.innerHTML = 'ðŸ”‡';
      console.log("muting!");
      window.local_stream.mute();
   }
};

        
</script>

</html>
